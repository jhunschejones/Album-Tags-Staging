# Album-Tags-Staging
This is a staging code-base for albumtags.com that is used to test larger site changes before pushing to the main repository. The main albumtags.com repository can be found [here](https://github.com/jhunschejones/album-tags).

### Updates 10/06/18
1. All the routes for the app have been refactored. Database and external calls have been pulled out of the routes for each page and placed in the `api.v1.route.js` route. All client JavaScript files have been updated with the new endpoints. This allows for removal of some duplicate code and easier updates for future backend changes.
2. The `require(‘newrelic’)` statement has been moved up from the app.js file into the `www` file so that it is the first package when Heroku calls `npm start`.
3. The `www` file was updated with Cluster functionality. The app should now serve up one version of the backend per CPU available. This should help handle multiple site requests better and make better use of the multi-core resources available on the Heroku dyno. There is a chance it will affect how data reports to New Relic, as well as database calls, so we are only deploying this in the staging code-base to start with.

### Updates 10/07/18
1. In this update the `POST` endpoint was removed and instead `{ upsert: true }` was added to the PUT endpoint so that if a record does not exist for an album it will create a new one. The client-side update script has also been updated so that it does not POST place-holder records when the page is accessed. This not only simplifies the code, it helps users on a slower connection because the update page does not have to wait for the `POST` request to finish before adding a new record.
2. Worker count was decreased yesterday as 8 workers was using more memory than desired. This commit moves the count up from 4 to 5 workers.
3. The app will now send a custom event and metric to New Relic when a worker dies, triggering an alert. There will need to be more work around making sure relevant data about the cause of a worker crash is available but this is the first step in gaining visibility into the cluster process. Though it is an advantage to be able to spin up a new worker when the app crashes without the user being aware, it does mean a larger problem could exist without the developers knowing.